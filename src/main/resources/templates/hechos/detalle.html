<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <title th:text="${hecho.titulo}">Detalle del Hecho</title>
</head>
<body>
<div th:replace="~{layout/layout :: layout(~{::title}, ~{::main}, 'public')}">
    <main>
        <div class="container mt-4">

            <!-- Detalles del Hecho -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h1 th:text="${hecho.titulo}">Título del Hecho</h1>
                    <!-- Botón de Editar Condicional -->
                    <a th:if="${#authorization.expression('isAuthenticated()') and hecho.creadorUsername != null and hecho.creadorUsername == #authentication.name and #temporals.createNow().minusDays(7).isBefore(hecho.fecCarga)}"
                       th:href="@{/metamapa/hechos/{id}/editar(id=${hecho.idOrigen})}"
                       class="btn btn-warning">
                        <i class="bi bi-pencil-fill"></i> Editar
                    </a>
                </div>
                <div class="card-body">
                    <p><strong>Categoría:</strong> <span th:text="${hecho.categoria}" class="badge bg-info">Categoría</span></p>
                    
                    <!-- Ubicación con Geocodificación Inversa -->
                    <p><strong>Ubicación:</strong> 
                        <span id="ubicacion-texto" class="text-muted">
                            <i class="bi bi-geo-alt"></i> <span th:text="'(' + ${hecho.latitud} + ', ' + ${hecho.longitud} + ')'"></span>
                        </span>
                    </p>
                    <input type="hidden" id="lat-data" th:value="${hecho.latitud}">
                    <input type="hidden" id="lon-data" th:value="${hecho.longitud}">

                    <script>
                        document.addEventListener("DOMContentLoaded", function() {
                            const lat = document.getElementById('lat-data').value;
                            const lon = document.getElementById('lon-data').value;
                            const textoUbicacion = document.getElementById('ubicacion-texto');

                            if (lat && lon) {
                                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data && data.display_name) {
                                            // Extraer partes relevantes (Ciudad, Provincia, País) para que no sea tan largo
                                            let parts = data.display_name.split(',');
                                            // Tomar las primeras 3 partes o mostrar todo si es corto
                                            let shortName = parts.slice(0, 3).join(','); 
                                            textoUbicacion.innerHTML = `<i class="bi bi-geo-alt-fill text-danger"></i> ${shortName}`;
                                            textoUbicacion.title = data.display_name; // Tooltip con nombre completo
                                        }
                                    })
                                    .catch(err => console.error("Error obteniendo ubicación:", err));
                            }
                        });
                    </script>

                    <p><strong>Descripción:</strong></p>
                        <p class="card-text" th:text="${hecho.descripcion}"></p>

                        <!-- Contenido Multimedia -->
                        <div th:if="${hecho.pathContenidoMultimedia != null and !hecho.pathContenidoMultimedia.isEmpty()}">
                            <h5 class="card-title mt-4">Contenido Multimedia</h5>
                            <div class="mt-3 border p-3 rounded">
                                <p>
                                    <a th:href="|http://localhost:8081/multimedia/${hecho.pathContenidoMultimedia}|" target="_blank">
                                        Abrir/Descargar contenido
                                    </a>
                                </p>
                                <img th:src="|http://localhost:8081/multimedia/${hecho.pathContenidoMultimedia}|" class="img-fluid rounded mt-2" alt="Previsualización de contenido multimedia. Si no carga, use el enlace de arriba.">
                            </div>
                        </div>
                    </div>
                    <div class="card-footer text-muted">
                        Aportado por: <span th:text="${hecho.creadorUsername ?: 'Anónimo'}"></span>
                        el <span th:text="${#temporals.format(hecho.fecCarga, 'dd/MM/yyyy HH:mm')}"></span>
            </div>

            <!-- Formulario para Solicitud de Eliminación -->
            <div class="card">
                <div class="card-header">
                    <h3>Solicitar Eliminación de este Hecho</h3>
                </div>








                <div class="card-body">
                    <form th:action="@{/metamapa/solicitudes-eliminacion}" method="post">
                        <input type="hidden" name="hechoId" th:value="${hecho.id}" />
                        <div class="mb-3">
                            <label for="motivo" class="form-label">Motivo de la solicitud</label>
                            <textarea class="form-control" id="motivo" name="motivo" rows="5"></textarea>
                            <small id="char-counter" class="form-text text-muted">0 caracteres</small>
                        </div>
                        <button type="submit" class="btn btn-danger">Enviar Solicitud de Eliminación</button>
                    </form>

                    <script th:inline="javascript">
                        /*<![CDATA[*/
                            const isAuthenticated = /*[[${#authorization.expression('isAuthenticated()')}]]*/ false;
                            const motivoTextarea = document.getElementById('motivo');
                            const charCounter = document.getElementById('char-counter');
                            const minChars = 500;

                            motivoTextarea.addEventListener('input', () => {
                                const currentCharCount = motivoTextarea.value.length;

                                if (isAuthenticated) {
                                    // Para usuarios logueados, solo mostrar contador simple
                                    charCounter.textContent = currentCharCount + ' caracteres';
                                    motivoTextarea.setCustomValidity(''); // Asegurarse de que no haya validación
                                } else {
                                    // Para usuarios anónimos (visualizadores), aplicar la validación estricta
                                    charCounter.textContent = currentCharCount + ' / ' + minChars + ' caracteres';
                                    if (currentCharCount < minChars) {
                                        motivoTextarea.setCustomValidity('El motivo debe tener al menos ' + minChars + 'caracteres.');
                                        charCounter.classList.add('text-danger');
                                        charCounter.classList.remove('text-success');
                                    } else {
                                        motivoTextarea.setCustomValidity('');
                                        charCounter.classList.remove('text-danger');
                                        charCounter.classList.add('text-success');
                                    }
                                }
                            });

                            // Añadir el atributo required dinámicamente para anónimos
                            if (!isAuthenticated) {
                                motivoTextarea.setAttribute('required', 'required');
                            }

                            // Disparar el evento al cargar para validar el estado inicial
                            document.addEventListener('DOMContentLoaded', () => {
                                motivoTextarea.dispatchEvent(new Event('input'));
                            });
                        /*]]>*/
                    </script>
                </div>















            </div>

        </div>
    </main>
</div>
</body>
</html>